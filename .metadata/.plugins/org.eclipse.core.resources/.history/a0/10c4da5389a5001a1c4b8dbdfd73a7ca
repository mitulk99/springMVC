package com.amazon.util;


import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

import org.apache.http.HttpHost;
import org.elasticsearch.action.search.SearchRequest;
import org.elasticsearch.action.search.SearchResponse;
import org.elasticsearch.client.RequestOptions;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.elasticsearch.common.geo.GeoDistance;
import org.elasticsearch.common.unit.DistanceUnit;
import org.elasticsearch.index.query.QueryBuilders;
import org.elasticsearch.rest.RestStatus;
import org.elasticsearch.search.SearchHit;
import org.elasticsearch.search.SearchHits;
import org.elasticsearch.search.builder.SearchSourceBuilder;
import org.elasticsearch.search.sort.SortBuilders;
import org.elasticsearch.search.sort.SortOrder;
import org.json.JSONArray;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;

public class Backend {
 	@Autowired	
    Coordinates call;
	public String Back(String pincode, String radius ,String category)
	{
		 String s="";
               	try {
              
               call.Coords(pincode);
               Double lat= call.Lat();
               Double lon= call.Lon();
   
				RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(new HttpHost("localhost",9200, "http")));
				SearchRequest searchRequest = new SearchRequest("my_locations"); 
				SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
				searchSourceBuilder.query(QueryBuilders
						  .geoDistanceQuery("location")
						  .point(lat,lon)
						  .distance(Double.valueOf(radius), DistanceUnit.KILOMETERS)
						  .geoDistance(GeoDistance.ARC));
				searchRequest.source(searchSourceBuilder.sort(SortBuilders.geoDistanceSort("location",lat,lon).order(SortOrder.ASC).unit(DistanceUnit.KILOMETERS)));
				SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);
				RestStatus status = searchResponse.status();
				SearchHits hits = searchResponse.getHits();
				SearchHit[] searchHits = hits.getHits();
				List<StoresDetails> details= new ArrayList<StoresDetails>();
				int i=1;
				for (SearchHit hit : searchHits) {
					JSONObject obj1= new JSONObject(hit.toString());
					JSONArray obj2=obj1.getJSONArray("sort");
					StoresDetails sd=new StoresDetails();
					obj1=obj1.getJSONObject("_source");
					if(obj1.get("category").equals(category) || category.equals("all")==true)
					{
						s=s+obj1;
					}
					if(obj1.has("merchant name")==true)
					sd.setMerchantname(obj1.get("merchant name").toString());
					if(obj1.has("open time")==true)
					sd.setOpentime(obj1.get("open time").toString());
					if(obj1.has("close time")==true)
					sd.setClosetime(obj1.get("close time").toString());
					if(obj1.has("address")==true)
					sd.setAddress(obj1.get("address").toString());
					if(obj1.has("category")==true)
					sd.setCategory(obj1.get("category").toString());
					if(obj1.has("home delivery")==true)
					sd.setRangeofhomedelivery(obj1.get("range of home delivery").toString());
					sd.setDistance(obj2.getDouble(0));
					i++;
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
               	finally {
               		return s;
               	}
        	//System.out.println(" done ");
	}
}
